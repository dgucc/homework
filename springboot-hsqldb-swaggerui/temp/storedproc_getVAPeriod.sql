--#SET TERMINATOR @
CREATE OR REPLACE PROCEDURE CALCISOC_QT.GET_VA_PERIOD(
	IN TAXYEAR INTEGER,
	IN TAXYEAR_TYPE VARCHAR(4),
	IN BALANCE_DATE DATE,
	IN AMOUNT DECIMAL(14,2),
	IN PAYMENT_DATE DATE
)
RESULT SETS 1
LANGUAGE SQL
BEGIN
DECLARE C_VA_PERIOD CURSOR WITH RETURN TO CLIENT FOR
	SELECT
		AMOUNT AS VA_AMOUNT, -- montant versement
		VARCHAR_FORMAT(PAYMENT_DATE, 'yyyy-mm-dd') AS PAYMENT_DATE,
		MIN(VA_TYPE) AS VA_PERIOD,
		VARCHAR_FORMAT(MIN(VA_DATE),'yyyy-mm-dd') AS VA_DATE,
		TAXYEAR_TYPE AS "TYPE"
	FROM (
		SELECT
			N_I_ANNEE,
			C_I_TYPE,
		    T.VA_TYPE,
		    T.VA_DATE
		FROM
		    CALCISOC_QT.VA_PERIOD,
		    TABLE (VALUES -- Transpose columns VA1, VA2, VA3, VA4 into rows
		        ('VA_PERIOD_1', D_I_DATE_VA1),
		        ('VA_PERIOD_2', D_I_DATE_VA2),
		        ('VA_PERIOD_3', D_I_DATE_VA3),
		        ('VA_PERIOD_4', D_I_DATE_VA4)
		    ) AS T(VA_TYPE, VA_DATE)
		WHERE
			T.VA_DATE IS NOT NULL
			AND N_I_ANNEE = TAXYEAR
			AND C_I_TYPE = TAXYEAR_TYPE  -- 'NORM','SPEC'
			AND	N_I_YEAR_BILAN = YEAR(BALANCE_DATE) -- annÃ©e date bilan
			AND	N_I_MONTH_BILAN = MONTH(BALANCE_DATE) -- mois date bilan
			AND T.VA_DATE > PAYMENT_DATE -- date versement avant date limite VA
		)
	GROUP BY
		N_I_ANNEE,
		C_I_TYPE
	HAVING
		PAYMENT_DATE < MIN(VA_DATE)-- prendre la 1re limite VA possible
	WITH UR
	;
	OPEN C_VA_PERIOD;
END;
@

CALL CALCISOC_QT.GET_VA_PERIOD(2024 ,'SPEC','2024-09-30', 1000, '2024-03-01');--1000.00	2024-03-01	VA_PERIOD_2	2024-04-11	SPEC
CALL CALCISOC_QT.GET_VA_PERIOD(2024 ,'SPEC','2024-07-31', 1500, '2024-02-02');--1500.00	2024-02-02	VA_PERIOD_2	2024-02-13	SPEC
CALL CALCISOC_QT.GET_VA_PERIOD(2024 ,'SPEC','2024-02-29', 2000, '2023-09-01');--2000.00	2023-09-01	VA_PERIOD_2	2023-09-12	SPEC
CALL CALCISOC_QT.GET_VA_PERIOD(2024 ,'SPEC','2023-12-31', 2500, '2023-09-04');--2500.00	2023-09-04	VA_PERIOD_3	2023-10-11	SPEC
CALL CALCISOC_QT.GET_VA_PERIOD(2023 ,'SPEC','2023-11-30', 3000, '2023-08-01');--3000.00	2023-08-01	VA_PERIOD_3	2023-09-12	SPEC
CALL CALCISOC_QT.GET_VA_PERIOD(2023 ,'SPEC','2023-09-30', 3500, '2023-07-15');--3500.00	2023-07-15	VA_PERIOD_4	2023-10-11	SPEC

CALL CALCISOC_QT.GET_VA_PERIOD(2024 ,'NORM','2024-11-30', 4000, '2023-12-12');--4000.00	2023-12-12	VA_PERIOD_1	2024-03-12	NORM
CALL CALCISOC_QT.GET_VA_PERIOD(2024 ,'NORM','2023-12-31', 4500, '2023-09-01');--4500.00	2023-09-01	VA_PERIOD_3	2023-10-11	NORM
CALL CALCISOC_QT.GET_VA_PERIOD(2024 ,'NORM','2023-12-31', 5000, '2023-07-15');--5000.00	2023-07-15	VA_PERIOD_3	2023-10-11	NORM
CALL CALCISOC_QT.GET_VA_PERIOD(2024 ,'NORM','2023-12-31', 5500, '2023-07-15');--5500.00	2023-07-15	VA_PERIOD_3	2023-10-11	NORM
CALL CALCISOC_QT.GET_VA_PERIOD(2024 ,'NORM','2023-12-31', 6000, '2023-11-15');--6000.00	2023-11-15	VA_PERIOD_4	2023-12-21	NORM
